<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akshay Kumar</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

<form id="emailForm">
    <label for="username">Username : </label>
    <input type="text" id="username" placeholder="Username" required><br>
    <label for="email">Email : </label>
    <input type="email" id="email" placeholder="Email" required><br>
    <button type="button" onclick="sendVerificationLink()">Send Verification Link</button>
</form>
<div id="logged" style="display: none;">
    <button id="signout" onclick="signout()">SignOut</button>
    <h1 id="usernamedata"></h1>
</div>

<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script>
    if(localStorage.getItem('username')===null){
    }else{loged()}

    function frmid(id){
        return document.getElementById(id);
    }
    
    $(document).ready(function() {
        $('#username').on('input', function() {
            if ($(this).val().indexOf(' ') !== -1) {
                alert('Username must be without space');
                this.value = this.value.replace(' ', '');
            }
        });
    });

    function signout(){
        localStorage.clear();
        window.location.href = "index.html";
    }
    function loged(){
        frmid("emailForm").style.display="none";
        frmid("logged").style.display="block";
        frmid('usernamedata').innerHTML="Welcome "+window.localStorage.getItem('username');
    }

    emailjs.init("lscd6HIw5Fjyl4V6J");

    function sendVerificationLink() {
        const emailInput = frmid('email');
        const username = frmid('username').value;
        const email = emailInput.value.trim();

        
        if (!isValidEmail(email)) {
            alert('Please enter a valid email address.');
            return;
        }
        const verificationCode = generateVerificationCode();
        const verificationLink = `${window.location.href}?code=${verificationCode}?username=${username}`;

        const templateParams = {
            to_email: email,
            verification_link: verificationLink
        };
        emailjs.send("service_zvgvl2g", "template_3n0owyp", templateParams)
            .then(() => {
                alert('Verification link sent. Please check your email.');
            }, (error) => {
                console.error('Error sending email:', error);
                alert('Error sending verification link. Please try again.');
            });
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function generateVerificationCode() {
        const length = 32;
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#~%*()-_=+[]{}|;:.';
        let verificationCode = '';

        for (let i = 0; i < length; i++) {
            const randomIndex = Math.floor(Math.random() * characters.length);
            verificationCode += characters.charAt(randomIndex);
        }
        return verificationCode;
    }

    function getparameters(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function verifyEmail() {
        const verificationCodeFromURL = getparameters('code');
        const username = getparameters('username').replace(":","");
        if (!verificationCodeFromURL) {
            return;
        }
        window.localStorage.setItem('username',username);
        window.location.href = "index.html";
    }
    window.onload = verifyEmail;
</script>

</body>
</html>
